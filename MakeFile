# SmartArb Engine - Complete Makefile

# Comprehensive automation for development, testing, and production deployment

# Optimized for Raspberry Pi 5 and cross-platform compatibility

# =============================================================================

# PROJECT CONFIGURATION

# =============================================================================

PROJECT_NAME := smartarb-engine
VERSION := $(shell grep -o â€˜â€œversionâ€: â€œ[^â€]*â€™ package.json 2>/dev/null | cut -dâ€™â€â€™ -f4 || echo â€œ1.0.0â€)
PYTHON := python3
PIP := pip3
VENV_DIR := venv
VENV_BIN := $(VENV_DIR)/bin
PYTHON_VENV := $(VENV_BIN)/python
PIP_VENV := $(VENV_BIN)/pip

# Docker configuration

DOCKER_IMAGE := $(PROJECT_NAME)
DOCKER_TAG := latest
DOCKER_REGISTRY := # Add your registry here

# Colors for terminal output

NC := \033[0m
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
PURPLE := \033[0;35m
CYAN := \033[0;36m
WHITE := \033[1;37m

# Platform detection

UNAME_S := $(shell uname -s)
UNAME_M := $(shell uname -m)
IS_RPI := $(shell [ -f /proc/cpuinfo ] && grep -q â€œBCMâ€ /proc/cpuinfo && echo â€œtrueâ€ || echo â€œfalseâ€)
IS_DOCKER := $(shell [ -f /.dockerenv ] && echo â€œtrueâ€ || echo â€œfalseâ€)

# Default target

.DEFAULT_GOAL := help

# =============================================================================

# HELP AND INFORMATION

# =============================================================================

.PHONY: help
help: ## Show this help message
@echo â€œ$(CYAN)SmartArb Engine - Makefile Commands$(NC)â€
@echo â€œ$(CYAN)=====================================$(NC)â€
@echo â€œâ€
@echo â€œ$(GREEN)Project: $(PROJECT_NAME) v$(VERSION)$(NC)â€
@echo â€œ$(GREEN)Platform: $(UNAME_S) $(UNAME_M)$(NC)â€
@echo â€œ$(GREEN)Raspberry Pi: $(IS_RPI)$(NC)â€
@echo â€œ$(GREEN)Docker: $(IS_DOCKER)$(NC)â€
@echo â€œâ€
@echo â€œ$(YELLOW)Available commands:$(NC)â€
@awk â€™BEGIN {FS = â€œ:.*##â€; printf â€œ\nâ€} /^[a-zA-Z0-9_-]+:.*?##/ { printf â€œ  $(CYAN)%-20s$(NC) %s\nâ€, $$1, $$2 } /^##@/ { printf â€œ\n$(YELLOW)%s$(NC)\nâ€, substr($$0, 5) } â€™ $(MAKEFILE_LIST)

.PHONY: info
info: ## Show system information
@echo â€œ$(BLUE)System Information:$(NC)â€
@echo â€œ  OS: $(UNAME_S)â€
@echo â€œ  Architecture: $(UNAME_M)â€
@echo â€œ  Raspberry Pi: $(IS_RPI)â€
@echo â€œ  Docker: $(IS_DOCKER)â€
@echo â€œ  Python: $(shell $(PYTHON) â€“version 2>/dev/null || echo â€˜Not foundâ€™)â€
@echo â€œ  Git: $(shell git â€“version 2>/dev/null || echo â€˜Not foundâ€™)â€
@echo â€œ  Docker: $(shell docker â€“version 2>/dev/null || echo â€˜Not foundâ€™)â€
@echo â€œ  Make: $(MAKE_VERSION)â€
@echo â€œâ€
@echo â€œ$(BLUE)Project Information:$(NC)â€
@echo â€œ  Name: $(PROJECT_NAME)â€
@echo â€œ  Version: $(VERSION)â€
@echo â€œ  Virtual Environment: $(VENV_DIR)â€
@echo â€œ  Python in venv: $(shell [ -f $(PYTHON_VENV) ] && $(PYTHON_VENV) â€“version || echo â€˜Not foundâ€™)â€

##@ ğŸš€ Quick Start
.PHONY: quick-start
quick-start: setup install test-basic health-check ## Complete quick setup and test
@echo â€œ$(GREEN)âœ… SmartArb Engine ready to use!$(NC)â€
@echo â€œ$(YELLOW)Next steps:$(NC)â€
@echo â€œ  1. Edit configuration: $(CYAN)make edit-config$(NC)â€
@echo â€œ  2. Generate secrets: $(CYAN)make secrets$(NC)â€
@echo â€œ  3. Start application: $(CYAN)make run$(NC)â€

##@ ğŸ› ï¸ Setup and Installation
.PHONY: setup
setup: check-system install-system setup-venv install-deps create-dirs setup-git-hooks ## Complete setup from scratch
@echo â€œ$(GREEN)âœ… Setup completed successfully!$(NC)â€

.PHONY: check-system
check-system: ## Check system prerequisites
@echo â€œ$(BLUE)Checking system prerequisitesâ€¦$(NC)â€
@echo â€œPython 3.11+: $(shell $(PYTHON) â€“version | grep -q â€œPython 3.1[1-9]â€ && echo â€œ$(GREEN)âœ“$(NC)â€ || echo â€œ$(RED)âœ—$(NC)â€)â€
@echo â€œGit: $(shell command -v git >/dev/null 2>&1 && echo â€œ$(GREEN)âœ“$(NC)â€ || echo â€œ$(RED)âœ—$(NC)â€)â€
@echo â€œMake: $(shell command -v make >/dev/null 2>&1 && echo â€œ$(GREEN)âœ“$(NC)â€ || echo â€œ$(RED)âœ—$(NC)â€)â€
@echo â€œCurl: $(shell command -v curl >/dev/null 2>&1 && echo â€œ$(GREEN)âœ“$(NC)â€ || echo â€œ$(RED)âœ—$(NC)â€)â€
@if [ â€œ$(IS_RPI)â€ = â€œtrueâ€ ]; then   
echo â€œ$(YELLOW)Raspberry Pi detected - checking RPi-specific toolsâ€¦$(NC)â€;   
echo â€œvcgencmd: $(shell command -v vcgencmd >/dev/null 2>&1 && echo â€œ$(GREEN)âœ“$(NC)â€ || echo â€œ$(RED)âœ—$(NC)â€)â€;   
echo â€œGPIO access: $(shell [ -w /dev/gpiomem ] && echo â€œ$(GREEN)âœ“$(NC)â€ || echo â€œ$(YELLOW)âš $(NC)â€)â€;   
fi

.PHONY: install-system
install-system: ## Install system dependencies (requires sudo)
@echo â€œ$(BLUE)Installing system dependenciesâ€¦$(NC)â€
@if [ â€œ$(UNAME_S)â€ = â€œLinuxâ€ ]; then   
if command -v apt >/dev/null 2>&1; then   
sudo apt update && sudo apt install -y   
python3-dev python3-pip python3-venv   
build-essential pkg-config   
libpq-dev libssl-dev libffi-dev   
git curl wget htop vim;   
elif command -v yum >/dev/null 2>&1; then   
sudo yum install -y python3-devel python3-pip   
gcc gcc-c++ make pkgconfig   
postgresql-devel openssl-devel libffi-devel   
git curl wget htop vim;   
fi;   
elif [ â€œ$(UNAME_S)â€ = â€œDarwinâ€ ]; then   
if command -v brew >/dev/null 2>&1; then   
brew install python@3.11 postgresql openssl libffi git;   
fi;   
fi

.PHONY: setup-venv
setup-venv: $(VENV_DIR)/bin/activate ## Create Python virtual environment

$(VENV_DIR)/bin/activate:
@echo â€œ$(BLUE)Creating Python virtual environmentâ€¦$(NC)â€
$(PYTHON) -m venv $(VENV_DIR)
$(PIP_VENV) install â€“upgrade pip setuptools wheel

.PHONY: install-deps
install-deps: setup-venv ## Install Python dependencies
@echo â€œ$(BLUE)Installing Python dependenciesâ€¦$(NC)â€
@if [ -f requirements.txt ]; then   
$(PIP_VENV) install -r requirements.txt;   
else   
echo â€œ$(RED)requirements.txt not found - installing basic dependenciesâ€¦$(NC)â€;   
$(PIP_VENV) install asyncio aiohttp asyncpg redis structlog pydantic psutil ccxt anthropic pytest;   
fi

.PHONY: install-dev
install-dev: setup-venv ## Install development dependencies
@echo â€œ$(BLUE)Installing development dependenciesâ€¦$(NC)â€
$(PIP_VENV) install   
pytest pytest-asyncio pytest-mock pytest-cov pytest-benchmark   
black flake8 mypy isort pre-commit   
sphinx sphinx-rtd-theme   
memory-profiler line-profiler

.PHONY: create-dirs
create-dirs: ## Create necessary directories
@echo â€œ$(BLUE)Creating project directoriesâ€¦$(NC)â€
@mkdir -p logs data config secrets backups
@mkdir -p tests/unit tests/integration tests/e2e
@mkdir -p docs/api docs/user
@chmod 700 secrets
@echo â€œ$(GREEN)âœ“ Directories created$(NC)â€

.PHONY: setup-git-hooks
setup-git-hooks: ## Setup Git pre-commit hooks
@if [ -f .pre-commit-config.yaml ]; then   
echo â€œ$(BLUE)Setting up Git hooksâ€¦$(NC)â€;   
$(VENV_BIN)/pre-commit install;   
echo â€œ$(GREEN)âœ“ Git hooks installed$(NC)â€;   
else   
echo â€œ$(YELLOW)âš  .pre-commit-config.yaml not found - skipping Git hooks$(NC)â€;   
fi

##@ ğŸ”§ Development
.PHONY: install
install: install-deps ## Install dependencies

.PHONY: dev-install
dev-install: install-dev setup-git-hooks ## Install development environment

.PHONY: upgrade
upgrade: setup-venv ## Upgrade all dependencies
@echo â€œ$(BLUE)Upgrading dependenciesâ€¦$(NC)â€
$(PIP_VENV) install â€“upgrade pip setuptools wheel
@if [ -f requirements.txt ]; then   
$(PIP_VENV) install â€“upgrade -r requirements.txt;   
fi

.PHONY: freeze
freeze: ## Generate requirements.txt from current environment
@echo â€œ$(BLUE)Generating requirements.txtâ€¦$(NC)â€
$(PIP_VENV) freeze > requirements.txt
@echo â€œ$(GREEN)âœ“ requirements.txt updated$(NC)â€

.PHONY: fix-imports
fix-imports: setup-venv ## Fix missing imports automatically
@echo â€œ$(BLUE)Fixing import issuesâ€¦$(NC)â€
$(PYTHON_VENV) scripts/fix_imports.py â€“verbose

.PHONY: format
format: setup-venv ## Format code with black and isort
@echo â€œ$(BLUE)Formatting codeâ€¦$(NC)â€
$(VENV_BIN)/black src tests scripts â€“line-length 100
$(VENV_BIN)/isort src tests scripts â€“profile black

.PHONY: lint
lint: setup-venv ## Run linting checks
@echo â€œ$(BLUE)Running linting checksâ€¦$(NC)â€
$(VENV_BIN)/flake8 src tests scripts â€“max-line-length=100 â€“ignore=E203,W503
$(VENV_BIN)/mypy src â€“ignore-missing-imports

.PHONY: quality
quality: format lint ## Run all code quality checks
@echo â€œ$(GREEN)âœ… Code quality checks completed$(NC)â€

##@ ğŸ§ª Testing
.PHONY: test
test: setup-venv ## Run all tests
@echo â€œ$(BLUE)Running all testsâ€¦$(NC)â€
$(PYTHON_VENV) -m pytest tests/ -v â€“tb=short

.PHONY: test-basic
test-basic: setup-venv ## Run basic smoke tests
@echo â€œ$(BLUE)Running basic testsâ€¦$(NC)â€
$(PYTHON_VENV) -m pytest tests/test_basic.py -v

.PHONY: test-unit
test-unit: setup-venv ## Run unit tests only
@echo â€œ$(BLUE)Running unit testsâ€¦$(NC)â€
$(PYTHON_VENV) -m pytest tests/unit/ -v

.PHONY: test-integration
test-integration: setup-venv ## Run integration tests
@echo â€œ$(BLUE)Running integration testsâ€¦$(NC)â€
$(PYTHON_VENV) -m pytest tests/integration/ -v

.PHONY: test-e2e
test-e2e: setup-venv ## Run end-to-end tests
@echo â€œ$(BLUE)Running end-to-end testsâ€¦$(NC)â€
$(PYTHON_VENV) -m pytest tests/e2e/ -v

.PHONY: test-cov
test-cov: setup-venv ## Run tests with coverage report
@echo â€œ$(BLUE)Running tests with coverageâ€¦$(NC)â€
$(PYTHON_VENV) -m pytest tests/ â€“cov=src â€“cov-report=html â€“cov-report=term-missing
@echo â€œ$(GREEN)Coverage report generated: htmlcov/index.html$(NC)â€

.PHONY: test-watch
test-watch: setup-venv ## Run tests in watch mode
@echo â€œ$(BLUE)Running tests in watch modeâ€¦$(NC)â€
$(PYTHON_VENV) -m pytest tests/ -v â€“tb=short â€“looponfail

.PHONY: benchmark
benchmark: setup-venv ## Run performance benchmarks
@echo â€œ$(BLUE)Running performance benchmarksâ€¦$(NC)â€
$(PYTHON_VENV) -m pytest tests/ -v â€“benchmark-only â€“benchmark-sort=mean

##@ ğŸ” Security and Secrets
.PHONY: secrets
secrets: setup-venv ## Generate all secrets and configurations
@echo â€œ$(BLUE)Generating secretsâ€¦$(NC)â€
$(PYTHON_VENV) scripts/generate_secrets.py â€“environment=development â€“generate-ssl â€“docker-env

.PHONY: secrets-prod
secrets-prod: setup-venv ## Generate production secrets
@echo â€œ$(BLUE)Generating production secretsâ€¦$(NC)â€
$(PYTHON_VENV) scripts/generate_secrets.py â€“environment=production â€“master-password â€“docker-env â€“k8s-secrets

.PHONY: verify-secrets
verify-secrets: setup-venv ## Verify all secrets exist
@echo â€œ$(BLUE)Verifying secretsâ€¦$(NC)â€
$(PYTHON_VENV) scripts/generate_secrets.py â€“verify

.PHONY: rotate-secrets
rotate-secrets: setup-venv ## Rotate database and Redis passwords
@echo â€œ$(BLUE)Rotating secretsâ€¦$(NC)â€
$(PYTHON_VENV) scripts/generate_secrets.py â€“rotate postgres_password redis_password app_secret_key

.PHONY: security-scan
security-scan: setup-venv ## Run security scans
@echo â€œ$(BLUE)Running security scansâ€¦$(NC)â€
$(VENV_BIN)/bandit -r src/ -f json -o security-report.json
@echo â€œ$(GREEN)Security scan completed: security-report.json$(NC)â€

##@ ğŸ—„ï¸ Database
.PHONY: db-setup
db-setup: setup-venv ## Setup database
@echo â€œ$(BLUE)Setting up databaseâ€¦$(NC)â€
$(PYTHON_VENV) scripts/setup_database.py â€“create-db â€“run-migrations

.PHONY: db-migrate
db-migrate: setup-venv ## Run database migrations
@echo â€œ$(BLUE)Running database migrationsâ€¦$(NC)â€
$(PYTHON_VENV) -m alembic upgrade head

.PHONY: db-reset
db-reset: setup-venv ## Reset database (destructive!)
@echo â€œ$(RED)WARNING: This will destroy all data!$(NC)â€
@read -p â€œAre you sure? (yes/no): â€œ confirm && [ â€œ$$confirmâ€ = â€œyesâ€ ]
$(PYTHON_VENV) scripts/setup_database.py â€“reset-db â€“run-migrations

.PHONY: db-backup
db-backup: ## Backup database
@echo â€œ$(BLUE)Creating database backupâ€¦$(NC)â€
@mkdir -p backups
@timestamp=$$(date +%Y%m%d_%H%M%S);   
pg_dump smartarb_dev > backups/smartarb_backup_$$timestamp.sql
@echo â€œ$(GREEN)Backup created in backups/$(NC)â€

##@ ğŸƒâ€â™‚ï¸ Running the Application
.PHONY: run
run: setup-venv ## Run the application
@echo â€œ$(BLUE)Starting SmartArb Engineâ€¦$(NC)â€
$(PYTHON_VENV) -m src.core.engine

.PHONY: run-dev
run-dev: setup-venv ## Run in development mode
@echo â€œ$(BLUE)Starting SmartArb Engine (development)â€¦$(NC)â€
ENVIRONMENT=development DEBUG_MODE=true $(PYTHON_VENV) -m src.core.engine

.PHONY: run-paper
run-paper: setup-venv ## Run in paper trading mode
@echo â€œ$(BLUE)Starting SmartArb Engine (paper trading)â€¦$(NC)â€
TRADING_MODE=PAPER $(PYTHON_VENV) -m src.core.engine

.PHONY: daemon
daemon: setup-venv ## Run as daemon (background)
@echo â€œ$(BLUE)Starting SmartArb Engine as daemonâ€¦$(NC)â€
nohup $(PYTHON_VENV) -m src.core.engine > logs/smartarb.log 2>&1 &
@echo â€œ$(GREEN)SmartArb Engine started in background$(NC)â€

.PHONY: stop
stop: ## Stop running daemon
@echo â€œ$(BLUE)Stopping SmartArb Engineâ€¦$(NC)â€
pkill -f â€œsrc.core.engineâ€ || echo â€œNo running instances foundâ€

.PHONY: restart
restart: stop run ## Restart the application

.PHONY: status
status: setup-venv ## Show application status
@echo â€œ$(BLUE)SmartArb Engine Status:$(NC)â€
@if pgrep -f â€œsrc.core.engineâ€ > /dev/null; then   
echo â€œ$(GREEN)âœ“ Running$(NC)â€;   
ps aux | grep -E â€œsrc.core.engineâ€ | grep -v grep;   
else   
echo â€œ$(RED)âœ— Not running$(NC)â€;   
fi

##@ ğŸ³ Docker
.PHONY: docker-build
docker-build: ## Build Docker image
@echo â€œ$(BLUE)Building Docker imageâ€¦$(NC)â€
docker build -t $(DOCKER_IMAGE):$(DOCKER_TAG) .
@echo â€œ$(GREEN)Docker image built: $(DOCKER_IMAGE):$(DOCKER_TAG)$(NC)â€

.PHONY: docker-build-secure
docker-build-secure: ## Build secure Docker image
@echo â€œ$(BLUE)Building secure Docker imageâ€¦$(NC)â€
docker build -f Dockerfile.secure -t $(DOCKER_IMAGE):$(DOCKER_TAG)-secure .
@echo â€œ$(GREEN)Secure Docker image built: $(DOCKER_IMAGE):$(DOCKER_TAG)-secure$(NC)â€

.PHONY: docker-run
docker-run: ## Run Docker container
@echo â€œ$(BLUE)Running Docker containerâ€¦$(NC)â€
docker run -d â€“name $(PROJECT_NAME)   
-p 8000:8000   
â€“env-file .env.docker   
$(DOCKER_IMAGE):$(DOCKER_TAG)

.PHONY: docker-compose-up
docker-compose-up: ## Start with docker-compose
@echo â€œ$(BLUE)Starting with docker-composeâ€¦$(NC)â€
docker-compose up -d

.PHONY: docker-compose-down
docker-compose-down: ## Stop docker-compose services
@echo â€œ$(BLUE)Stopping docker-compose servicesâ€¦$(NC)â€
docker-compose down

.PHONY: docker-compose-secure
docker-compose-secure: ## Start with secure docker-compose
@echo â€œ$(BLUE)Starting with secure docker-composeâ€¦$(NC)â€
docker-compose -f docker-compose.secure.yml up -d

.PHONY: docker-logs
docker-logs: ## Show Docker logs
docker logs -f $(PROJECT_NAME)

.PHONY: docker-shell
docker-shell: ## Shell into Docker container
docker exec -it $(PROJECT_NAME) /bin/bash

.PHONY: docker-clean
docker-clean: ## Clean Docker resources
@echo â€œ$(BLUE)Cleaning Docker resourcesâ€¦$(NC)â€
docker container prune -f
docker image prune -f
docker volume prune -f

##@ ğŸ“Š Monitoring and Logs
.PHONY: health-check
health-check: setup-venv ## Run health check
@echo â€œ$(BLUE)Running health checkâ€¦$(NC)â€
$(PYTHON_VENV) scripts/health_check.py

.PHONY: logs
logs: ## Show application logs
@echo â€œ$(BLUE)Showing logsâ€¦$(NC)â€
tail -f logs/smartarb.log

.PHONY: logs-error
logs-error: ## Show error logs
@echo â€œ$(BLUE)Showing error logsâ€¦$(NC)â€
grep -i error logs/smartarb.log | tail -20

.PHONY: system-info
system-info: ## Show system information
@echo â€œ$(BLUE)System Information:$(NC)â€
@echo â€œCPU Usage: $$(top -bn1 | grep â€œCpu(s)â€ | awk â€˜{print $$2}â€™ | cut -dâ€™%â€™ -f1)â€
@echo â€œMemory Usage: $$(free | grep Mem | awk â€˜{printf(â€%.2f%%â€, ($$3/$$2) * 100.0)}â€™)â€
@echo â€œDisk Usage: $$(df -h / | tail -1 | awk â€˜{print $$5}â€™)â€
@if [ â€œ$(IS_RPI)â€ = â€œtrueâ€ ]; then   
echo â€œCPU Temperature: $$(vcgencmd measure_temp | cut -dâ€™=â€™ -f2 2>/dev/null || echo â€˜N/Aâ€™)â€;   
echo â€œGPU Memory: $$(vcgencmd get_mem gpu | cut -dâ€™=â€™ -f2 2>/dev/null || echo â€˜N/Aâ€™)â€;   
fi

.PHONY: monitor
monitor: ## Start monitoring dashboard
@echo â€œ$(BLUE)Starting monitoring dashboardâ€¦$(NC)â€
$(PYTHON_VENV) -m src.monitoring.dashboard

##@ ğŸ”§ Configuration
.PHONY: create-config
create-config: ## Create configuration files from templates
@echo â€œ$(BLUE)Creating configuration filesâ€¦$(NC)â€
@if [ ! -f .env ]; then   
cp .env.example .env;   
echo â€œ$(GREEN)âœ“ Created .env$(NC)â€;   
fi
@if [ ! -f config/settings.yaml ]; then   
cp config/settings.yaml.example config/settings.yaml;   
echo â€œ$(GREEN)âœ“ Created config/settings.yaml$(NC)â€;   
fi

.PHONY: edit-config
edit-config: create-config ## Edit configuration files
@echo â€œ$(BLUE)Opening configuration filesâ€¦$(NC)â€
@if command -v code >/dev/null 2>&1; then   
code .env config/settings.yaml;   
elif command -v nano >/dev/null 2>&1; then   
nano .env;   
nano config/settings.yaml;   
else   
echo â€œ$(YELLOW)Please edit .env and config/settings.yaml manually$(NC)â€;   
fi

.PHONY: validate-config
validate-config: setup-venv ## Validate configuration
@echo â€œ$(BLUE)Validating configurationâ€¦$(NC)â€
$(PYTHON_VENV) -c â€œfrom src.utils.config import ConfigManager; ConfigManager().validate_all()â€

##@ ğŸš€ Deployment
.PHONY: deploy-staging
deploy-staging: test quality security-scan ## Deploy to staging
@echo â€œ$(BLUE)Deploying to stagingâ€¦$(NC)â€
@echo â€œ$(YELLOW)This is a placeholder - implement your staging deployment$(NC)â€

.PHONY: deploy-prod
deploy-prod: test quality security-scan ## Deploy to production
@echo â€œ$(BLUE)Deploying to productionâ€¦$(NC)â€
@echo â€œ$(RED)WARNING: This will deploy to production!$(NC)â€
@read -p â€œAre you sure? (yes/no): â€œ confirm && [ â€œ$$confirmâ€ = â€œyesâ€ ]
@echo â€œ$(YELLOW)This is a placeholder - implement your production deployment$(NC)â€

.PHONY: backup
backup: ## Create full backup
@echo â€œ$(BLUE)Creating full backupâ€¦$(NC)â€
@mkdir -p backups
@timestamp=$$(date +%Y%m%d_%H%M%S);   
backup_dir=â€œbackups/full_backup_$$timestampâ€;   
mkdir -p â€œ$$backup_dirâ€;   
cp -r config â€œ$$backup_dir/â€;   
cp -r logs â€œ$$backup_dir/â€ 2>/dev/null || true;   
cp -r data â€œ$$backup_dir/â€ 2>/dev/null || true;   
tar -czf â€œ$$backup_dir.tar.gzâ€ -C backups â€œ$$(basename $$backup_dir)â€;   
rm -rf â€œ$$backup_dirâ€;   
echo â€œ$(GREEN)Backup created: $$backup_dir.tar.gz$(NC)â€

.PHONY: restore
restore: ## Restore from backup
@echo â€œ$(BLUE)Available backups:$(NC)â€
@ls -la backups/*.tar.gz 2>/dev/null || echo â€œNo backups foundâ€
@read -p â€œEnter backup filename: â€œ backup;   
if [ -f â€œbackups/$$backupâ€ ]; then   
tar -xzf â€œbackups/$$backupâ€ -C backups/;   
echo â€œ$(GREEN)Backup restored$(NC)â€;   
else   
echo â€œ$(RED)Backup not found$(NC)â€;   
fi

##@ ğŸ§¹ Cleanup
.PHONY: clean
clean: ## Clean build artifacts and cache
@echo â€œ$(BLUE)Cleaning build artifactsâ€¦$(NC)â€
find . -type d -name **pycache** -delete
find . -type f -name â€œ*.pycâ€ -delete
find . -type d -name â€œ*.egg-infoâ€ -exec rm -rf {} +
rm -rf build/ dist/ .pytest_cache/ .coverage htmlcov/
rm -rf .mypy_cache/ .tox/
@echo â€œ$(GREEN)âœ“ Cleanup completed$(NC)â€

.PHONY: clean-all
clean-all: clean ## Clean everything including venv and data
@echo â€œ$(RED)WARNING: This will remove virtual environment and data!$(NC)â€
@read -p â€œAre you sure? (yes/no): â€œ confirm && [ â€œ$$confirmâ€ = â€œyesâ€ ]
rm -rf $(VENV_DIR)/ logs/ data/ .coverage htmlcov/
@echo â€œ$(GREEN)âœ“ Complete cleanup finished$(NC)â€

.PHONY: clean-secrets
clean-secrets: ## Securely clean secrets (use with caution!)
@echo â€œ$(RED)WARNING: This will permanently delete all secrets!$(NC)â€
@read -p â€œAre you sure? (yes/NO): â€œ confirm && [ â€œ$$confirmâ€ = â€œyesâ€ ]
$(PYTHON_VENV) scripts/generate_secrets.py â€“cleanup

##@ ğŸ¯ Raspberry Pi Specific
.PHONY: rpi-optimize
rpi-optimize: ## Apply Raspberry Pi optimizations
@if [ â€œ$(IS_RPI)â€ = â€œtrueâ€ ]; then   
echo â€œ$(BLUE)Applying Raspberry Pi optimizationsâ€¦$(NC)â€;   
$(PYTHON_VENV) scripts/setup_system.py â€“raspberry-pi â€“external-ssd;   
else   
echo â€œ$(YELLOW)Not running on Raspberry Pi - skipping$(NC)â€;   
fi

.PHONY: rpi-temp
rpi-temp: ## Show Raspberry Pi temperature
@if [ â€œ$(IS_RPI)â€ = â€œtrueâ€ ]; then   
echo â€œ$(BLUE)Raspberry Pi Temperature:$(NC)â€;   
vcgencmd measure_temp;   
vcgencmd get_throttled;   
else   
echo â€œ$(YELLOW)Not running on Raspberry Pi$(NC)â€;   
fi

.PHONY: rpi-info
rpi-info: ## Show Raspberry Pi system information
@if [ â€œ$(IS_RPI)â€ = â€œtrueâ€ ]; then   
echo â€œ$(BLUE)Raspberry Pi Information:$(NC)â€;   
cat /proc/cpuinfo | grep -E â€œ(model name|Hardware|Revision)â€ | head -3;   
vcgencmd version;   
vcgencmd get_mem arm && vcgencmd get_mem gpu;   
df -h;   
else   
echo â€œ$(YELLOW)Not running on Raspberry Pi$(NC)â€;   
fi

##@ ğŸ“š Documentation
.PHONY: docs
docs: setup-venv ## Generate documentation
@echo â€œ$(BLUE)Generating documentationâ€¦$(NC)â€
$(VENV_BIN)/sphinx-build -b html docs/ docs/_build/
@echo â€œ$(GREEN)Documentation generated: docs/_build/index.html$(NC)â€

.PHONY: docs-serve
docs-serve: setup-venv ## Serve documentation locally
@echo â€œ$(BLUE)Serving documentation at http://localhost:8080$(NC)â€
cd docs/_build && $(PYTHON) -m http.server 8080

##@ ğŸ¯ All-in-One Commands
.PHONY: full-setup
full-setup: install-system setup secrets create-config db-setup ## Complete setup for new installation
@echo â€œ$(GREEN)ğŸ‰ Full setup completed!$(NC)â€
@echo â€œ$(CYAN)Next steps:$(NC)â€
@echo â€œ  1. Edit your configuration: $(YELLOW)make edit-config$(NC)â€
@echo â€œ  2. Add your API keys to .env and config/settings.yamlâ€
@echo â€œ  3. Run tests: $(YELLOW)make test$(NC)â€
@echo â€œ  4. Start the application: $(YELLOW)make run$(NC)â€

.PHONY: ci
ci: quality test security-scan ## Run all CI checks
@echo â€œ$(GREEN)âœ… All CI checks passed!$(NC)â€

.PHONY: release
release: clean quality test security-scan docker-build ## Prepare release
@echo â€œ$(GREEN)ğŸš€ Release ready!$(NC)â€

# =============================================================================

# INTERNAL TARGETS (not shown in help)

# =============================================================================

.PHONY: _check-venv
_check-venv:
@if [ ! -f $(PYTHON_VENV) ]; then   
echo â€œ$(RED)Virtual environment not found. Run: make setup-venv$(NC)â€;   
exit 1;   
fi

# Auto-update Makefile from template (if template exists)

.PHONY: update-makefile
update-makefile:
@if [ -f Makefile.template ]; then   
cp Makefile.template Makefile;   
echo â€œ$(GREEN)Makefile updated from template$(NC)â€;   
fi